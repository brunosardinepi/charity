{% extends '_layout.html' %}
{% load static from staticfiles %}
{% load donation_extras %}

{% block title %} Profile | {{ block.super }}{% endblock %}

{% block head_extra %}
    <script src="{% static 'js/comment_csrf.js' %}"></script>

    <script>
        $(document).on("click", ".set-default", function(event) {
            event.preventDefault();
            var url = "{% url 'donation:default_card' %}";
            var id = $(this).closest("span").attr("id");
            $.ajax({
                url : url,
                type : "POST",
                traditional: true,
                data : {
                    id : id
                },
                success : function(json) {
                    $(".default").html("<a class='set-default' href=''>Set default</a>");
                    $("#default-" + json.id).text("Default");
                }
            });
        });

        $(document).on("click", ".delete-plan", function(event) {
            event.preventDefault();
            var url = "{% url 'plans:delete_plan' %}";
            var id = $(this).attr("id");
            $.ajax({
                url : url,
                type : "POST",
                traditional: true,
                data : {
                    id : id
                },
                success : function(json) {
                    var plan = $("#" + id)
                    plan.closest("li").remove();
                }
            });
        });
    </script>

{% endblock %}

{% block body_content %}

    <img src="{{ userprofile.profile_image.image.url }}" width="300"/>
    
    <form action="" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form.as_p }}
        <input type="submit" value="Update profile" />
    </form>

    <p>Stripe Customer ID: {{ userprofile.stripe_customer_id }}</p>

    <h2>Pages I Admin</h2>
    <ul>
        {% for p in userprofile.admin_pages %}
            <li><a href="{% url 'page' page_slug=p.page_slug %}">{{ p.name }}</a></li>
        {% endfor %}
    </ul>   

    <h2>Pages I Manage</h2>
    <ul>
        {% for p in userprofile.manager_pages %}
            <li><a href="{% url 'page' page_slug=p.page_slug %}">{{ p.name }}</a></li>
        {% endfor %}
    </ul>   

    <h2>Campaigns I Admin</h2>
    <ul>
        {% for c in userprofile.admin_campaigns %}
            <li><a href="{% url 'campaign' page_slug=c.page.page_slug campaign_pk=c.pk campaign_slug=c.campaign_slug %}">{{ c.name }}</a></li>
        {% endfor %}
    </ul>

    <h2>Campaigns I Manage</h2>
    <ul>
        {% for c in userprofile.manager_campaigns %}
            <li><a href="{% url 'campaign' page_slug=c.page.page_slug campaign_pk=c.pk campaign_slug=c.campaign_slug %}">{{ c.name }}</a></li>
        {% endfor %}
    </ul>   

    <h2>Page Subscriptions</h2>
    <ul>
        {% for s in userprofile.subscriptions %}
            <li><a href="{% url 'page' page_slug=s.page_slug %}">{{ s.name }}</a></li>
        {% endfor %}
    </ul>

    <h2><a href="{% url 'invitations:pending_invitations'  %}">My Pending Page invitations</a></h2>

    <h2>Invitations I've Sent</h2>
    <ul>
        {% for i in userprofile.invitations %}
            <li>Invitation to {% if i.page %}{{ i.page.name }}{% elif i.campaign %}{{ i.campaign.name }}{% endif %} sent to {{ i.invite_to }} on {{ i.date_created }}</li>
        {% endfor %}
    </ul>

    <p><a href="{% url 'userprofile:profile_image_upload' %}">Upload Image</a></p>

    <h3>Saved Credit Cards</h3>
    {% if cards %}
        <ul>
            {% for x, c in cards.items %}
                <form action="{% url 'userprofile:update_card' %}" method="post">
                    {% csrf_token %}
                    <input type="text" name="name" value="{{ c.name }}" placeholder="Card name" maxlength="100" id="id_name" />
                    <input type="text" name="exp_month" value="{{ c.exp_month }}" placeholder="Exp Month" maxlength="2" id="id_exp_month" />
                    <input type="text" name="exp_year" value="{{ c.exp_year }}" placeholder="Exp Year" maxlength="4" id="id_exp_year" />
                    <input type="hidden" name="id" value="{{ c.id }}" />
                    <span class="default" id="default-{{ c.id }}">{% if c.default == True %}Default{% else %}<a class="set-default" href="">Set default</a>{% endif %}</span>
                    <input type="submit" name="save" value="Save" />
                    <input type="submit" name="delete" value="Delete" />
                </form>
            {% endfor %}
        </ul>
    {% endif %}

    <h3>Add Credit Card</h3>
    <form action="{% url 'userprofile:add_card' %}" method="post" id="add-card-form">
        {% csrf_token %}
        <div class="form-row">
            <label for="card-element">Credit or debit card</label>
            <div id="card-element"></div>
            <div id="card-errors" role="alert"></div>
        </div>
        <button>Add card</button>
    </form>

    <h3>Recurring Donations</h3>
    {% if userprofile.plans %}
        <ul>
            {% for p in userprofile.plans %}
                <li id="test">{{ p.amount|cents_to_dollars }} every {{ p.interval }} to <a href="{% url 'page' page_slug=p.page.page_slug %}">{{ p.page }}</a>{% if p.campaign %} via <a href="{% url 'campaign' page_slug=p.page.page_slug campaign_pk=p.campaign.pk campaign_slug=p.campaign.campaign_slug %}">{{ p.campaign }}</a>{% endif %} - <a class="delete-plan" id="plan-{{ p.id }}" href="">Delete</a></li>
            {% endfor %}
        </ul>
    {% endif %}

    <h3>Donations</h3>
    {% if userprofile.donations %}
        <ul>
            {% for d in userprofile.donations %}
                <li>{{ d.amount|cents_to_dollars }} to <a href="{% url 'page' page_slug=d.page.page_slug %}">{{ d.page }}</a>{% if d.campaign %} via <a href="{% url 'campaign' page_slug=d.page.page_slug campaign_pk=d.campaign.pk campaign_slug=d.campaign.campaign_slug %}">{{ d.campaign }}</a>{% endif %} @ {{ d.date }}</li>
            {% endfor %}
        </ul>
    {% endif %}    

    <h3>User Images</h3>
    <ul>
        {% for image in userprofile.images %}
            <li><img src="{{ image.image.url }}" width="200" />{{ image.caption }}<br>
            <p><a href="{% url 'userprofile:user_image_delete' image_pk=image.pk %}">Delete Image</a></p>
            <p><a href="{% url 'userprofile:user_profile_update' image_pk=image.pk %}">Update Profile Image</a></p></li>
        {% endfor %}
    </ul>

    <script>
        function stripeTokenHandler(token) {
            var form = document.getElementById('add-card-form');
            var hiddenInput = document.createElement('input');
            hiddenInput.setAttribute('type', 'hidden');
            hiddenInput.setAttribute('name', 'stripeToken');
            hiddenInput.setAttribute('value', token.id);
            form.appendChild(hiddenInput);

            form.submit();
        }

        var stripe = Stripe('{{ api_pk }}');
        var elements = stripe.elements();

        var style = {
            base: {
                fontSize: '16px',
                lineHeight: '24px'
            }
        };

        var card = elements.create('card', {style: style});
        card.mount('#card-element');

        card.addEventListener('change', function(event) {
            var displayError = document.getElementById('card-errors');
            if (event.error) {
                displayError.textContent = event.error.message;
            } else {
                displayError.textContent = '';
            }
        });

        var form = document.getElementById('add-card-form');
        form.addEventListener('submit', function(event) {
            event.preventDefault();

            var extraDetails = {
                name: "{{ request.user.first_name }} {{ request.user.last_name }}",
            };

            stripe.createToken(card, extraDetails).then(function(result) {
                if (result.error) {
                    var errorElement = document.getElementById('card-errors');
                    errorElement.textContent = result.error.message;
                } else {
                    stripeTokenHandler(result.token);
                }
            });
        });
    </script>

{% endblock %}
