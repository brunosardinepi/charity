{% extends '_layout.html' %}
{% load static from staticfiles %}
{% load guardian_tags %}
{% load comment_extras %}

{% block title %} {{ page.name }} | {{ block.super }}{% endblock %}

{% block head_extra %}
    <script>
        $(document).ready(function() {

            $("#subscribe").click(function () {
                var action = $("#subscribe").attr("name");
                var url = "/subscribe/" + {{ page.pk }} + "/" + action + "/";
                $.get(url, function (data) {
                    subscribe_attr = JSON.parse(data);
                    $("#subscribe").attr("name", subscribe_attr.name);
                    $("#subscribe").css("background-color", subscribe_attr.color);
                    $("#subscribe").text(subscribe_attr.value);
                });
            });

            function comment() {
                console.log("comment function accessed");
                console.log($("#comment-text").val());
            };

            $("#comment").on('submit', function(event) {
                event.preventDefault();
                console.log("comment submit found");
                comment();
            });

        });
    </script>
{% endblock %}

{% block body_content %}
    <h1>{{ page.name }}</h1>
    {% if page.icon %}
        <img src="{{ page.icon.url }}" width="300" />
    {% endif %}
    <p>Description: {{ page.description }}</p>
    <p>Category: {{ page.get_category_display }}</p>
    <p>${{ page.donation_money }} raised by {{ page.donation_count }} donors</p>

    {% if request.user.is_authenticated %}
        <button id="subscribe" name="{{ subscribe_attr.name }}" style="background-color:{{ subscribe_attr.color }}">{{ subscribe_attr.value  }}</button>
    {% else %}
        <button onclick="location.href='{% url 'signup' %}?next={{request.path}}'" style="background-color:green">Subscribe</button>
    {% endif %}

    <h3>Active Campaigns</h3>
    <ul>
        {% for campaign in active_campaigns %}
            <li><a href="{% url 'campaign' page_slug=page.page_slug campaign_pk=campaign.pk campaign_slug=campaign.campaign_slug %}">{{ campaign.name }}</a> (${{ campaign.donation_money }} of ${{ campaign.goal }} goal)</li>
        {% endfor %}
    </ul>

    <h3>Past Campaigns</h3>
    <ul>
        {% for campaign in inactive_campaigns %}
            <li><a href="{% url 'campaign' page_slug=page.page_slug campaign_pk=campaign.pk campaign_slug=campaign.campaign_slug %}">{{ campaign.name }}</a> (${{ campaign.donation_money }} of ${{ campaign.goal }} goal)</li>
        {% endfor %}
    </ul>

    <p><a href="{% url 'campaign_create' page_slug=page.page_slug %}">Create Campaign</a></p>

    <h3>Comments</h3>
    <form id="comment" action="{% url 'comments:comment_page' page_pk=page.pk %}" method="POST">
        {% csrf_token %}
        {{ form.as_p }}
        <input type="submit" value="Comment" />
    </form>
    {% if comments %}
        <ul>
            {% for c in comments %}
                <li>{{ c.content }} - {{ c.user.userprofile.first_name }} {{ c.user.userprofile.last_name }} @ {{ c.date }}</li>
                {% comment_replies c.pk as replies %}
                {% if replies %}
                    <ul>
                        {% for r in replies %}
                            <li>{{ r.content }} - {{ r.user.userprofile.first_name }} {{ r.user.userprofile.last_name }} @ {{ r.date }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            {% endfor %}
        </ul>
    {% else %}
        <p>No comments</p>
    {% endif %}

    {% if request.user.userprofile in page.admins.all %}
        <h4>Admin</h4>
        <p><a href="{% url 'page_edit' page_slug=page.page_slug %}">Edit Page</a></p>
        <p><a href="{% url 'page_delete' page_slug=page.page_slug %}">Delete Page</a></p>
        {% if managers %}
            <h5>Managers</h5>
            <form method="POST" action"">
                {% csrf_token %}
                <table>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Edit</th>
                        <th>Delete</th>
                        <th>Invite</th>
                        <th></th>
                    </tr>
                {% for manager in managers %}
                    {% get_obj_perms manager.user for page as "page_perms" %}
                    <tr>
                        <td>{{ manager.first_name }} {{ manager.last_name }}</td>
                        <td>{{ manager.user.email }}</td>
                        <td><input name="permissions[]" type="checkbox" value="{{ manager.pk }}_manager_edit" {% if 'manager_edit' in page_perms %}checked{% endif %} /></td>
                        <td><input name="permissions[]" type="checkbox" value="{{ manager.pk }}_manager_delete" {% if 'manager_delete' in page_perms %}checked{% endif %} /></td>
                        <td><input name="permissions[]" type="checkbox" value="{{ manager.pk }}_manager_invite" {% if 'manager_invite' in page_perms %}checked{% endif %} /></td>
                        <td><a href="{% url 'remove_manager' page_slug=page.page_slug manager_pk=manager.pk %}">Remove<a/></td>
                {% endfor %}
                </table>
                <input type="submit" value="Save" />
            </form>
        {% endif %}
    {% else %}
        <p>you're NOT an admin</p>
    {% endif %}

    {% get_obj_perms request.user for page as "page_perms" %}
    {% if page_perms %}
        <h4>Manager</h4>
    {% endif %}
    {% if "manager_edit" in page_perms %}
        <p><a href="{% url 'page_edit' page_slug=page.page_slug %}">Edit Page</a></p>
    {% endif %}
    {% if "manager_delete" in page_perms %}
        <p><a href="{% url 'page_delete' page_slug=page.page_slug %}">Delete Page</a></p>
    {% endif %}
    {% if "manager_invite" in page_perms %}
        <p><a href="{% url 'page_invite' page_slug=page.page_slug  %}">Invite others to manage Page</a></p>
    {% endif %}
{% endblock %}
