{% extends '_layout.html' %}
{% load static from staticfiles %}
{% load guardian_tags %}
{% load donation_extras %}

{% block title %} {{ page.name }} | {{ block.super }}{% endblock %}

{% block head_extra %}
    <script>
        var model = "page";
        var model_pk = {{ page.pk }};
    </script>
    <script src="{% static 'js/comment_csrf.js' %}"></script>
    <script src="{% static 'js/vote.js' %}"></script>
    <script src="{% static 'js/subscribe.js' %}"></script>
    <script>
        $(document).ready(function() {

            $(".delete-page").click(function () {
                return confirm("Are you sure you want to delete this Page?");
            });
            
            function comment() {
                $.ajax({
                    url : "{% url 'comments:comment' model='page' pk=page.pk %}",
                    type : "POST",
                    data : { comment_text : $("#comment-text").val() },
                    success : function(json) {
                        $("#comment-text").val('');
                        if (!$("#comment_list").length) {
                            $("#no-comments").remove();
                            $("#comment").after("<ul id='comment_list'></ul>");
                        }
                        $("#comment_list").prepend("<li id='comment-" + json.id + "' class='comment'>" + json.content + " - " + json.user + " @ " + json.date + " - <a class='show-reply' id='" + json.id + "' href=''>Reply</a> - <a id='delete-comment-" + json.id + "' class='delete-cr' href=''>Delete</a></li>");
                    }
                });
            };

            $("#comment").on('submit', function(event) {
                event.preventDefault();
                comment();
            });

            function show_reply_textarea(event) {
                var url = "{% url 'comments:reply' comment_pk=0 %}".replace(0, event.target.id);
                $(event.target).parent().after("<form id='reply' action=" + url + " method='POST'>{% csrf_token %}<textarea id='reply-text'></textarea><input type='submit' value='Reply' /></form>");
            };

            function reply(id) {
                $.ajax({
                    url : "{% url 'comments:reply' comment_pk=0 %}".replace(0, id),
                    type : "POST",
                    data : { reply_text : $("#reply-text").val() },
                    success : function(json) {
                        $("#reply").remove();
                        if (!$("#comment-" + id + "-replies").length) {
                            if ($("#delete-comment-" + id).length) {
                                $("#delete-comment-" + id).after("<ul id='comment-" + id + "-replies' class='reply-list'></ul>");
                            } else if ("#" + id.length) {
                                $("#" + id).after("<ul id='comment-" + id + "-replies' class='reply-list'></ul>");
                            }
                        }
                        $("#comment-" + id + "-replies").append("<li id='reply-" + json.id + "'>" + json.content + " - " + json.user + " @ " + json.date + " - <a id='delete-reply-" + json.id + "' class='delete-cr' href=''>Delete</a></li>");
                    }
                });
            };

            $(document).on('click', ".show-reply", function(event) {
                event.preventDefault();
                show_reply_textarea(event);
            });

            $(document).on('submit', "#reply", function(event) {
                event.preventDefault();
                var id = $("#reply").prev().find(".show-reply").attr("id");
                reply(id);
            });

            function delete_obj(event) {
                var arr = event.target.id.split('-');
                var url = "{% url 'comments:delete' model=0 pk=1 %}".replace(0, arr[1]).replace(1, arr[2]);
                $.get(url, function () {
                    $("#" + arr[1] + "-" + arr[2]).remove();
                });
            };

            $(document).on('click', ".delete-cr", function(event) {
                event.preventDefault();
                delete_obj(event);
            });

        });
    </script>

{% endblock %}

{% block body_content %}
    <h1>{{ page.name }}</h1>
    <img src="{{ page.profile_picture.image.url }}" width="200" />
    <p>Trending score: {{ page.trending_score }}</p>
    <p>Type: {{ page.get_type_display }}</p>
    <p>Location: {% if page.city %}{{ page.city }}{% endif %}{% if page.city and page.state %}, {% endif %}{% if page.state %}{{ page.state }}{% endif %}</p>
    <p>Description: {{ page.description }}</p>
    <p>Category: {{ page.get_category_display }}</p>
    <p>Contact email: {{ page.contact_email }}</p>
    <p>Contact phone: {{ page.contact_phone }}</p>
    <p>Website: {{ page.website }}</p>
    <p>{{ page.donation_money|cents_to_dollars }} raised by {{ page.donation_count }} donors</p>

    {% if request.user.is_authenticated %}
        <button id="subscribe" name="{{ subscribe_attr.name }}" style="background-color:{{ subscribe_attr.color }}">{{ subscribe_attr.value  }}</button>
    {% else %}
        <button onclick="location.href='{% url 'signup' %}?next={{request.path}}'" style="background-color:green">Subscribe</button>
    {% endif %}

    <h3>Active Campaigns</h3>
    <ul>
        {% for campaign in page.active_campaigns %}
            <li><a href="{% url 'campaign' page_slug=page.page_slug campaign_pk=campaign.pk campaign_slug=campaign.campaign_slug %}">{{ campaign.name }}</a> ({{ campaign.donation_money|cents_to_dollars }} of ${{ campaign.goal }} goal)</li>
        {% endfor %}
    </ul>

    <h3>Past Campaigns</h3>
    <ul>
        {% for campaign in page.inactive_campaigns %}
            <li><a href="{% url 'campaign' page_slug=page.page_slug campaign_pk=campaign.pk campaign_slug=campaign.campaign_slug %}">{{ campaign.name }}</a> (${{ campaign.donation_money }} of ${{ campaign.goal }} goal)</li>
        {% endfor %}
    </ul>

    <p><a href="{% url 'campaign_create' page_slug=page.page_slug %}">Create Campaign</a></p>

    {% include "comments/comments.html" with model="page" obj=page %}

    {% get_obj_perms request.user for page as "page_perms" %}
    {% if request.user.userprofile in page.admins.all or "manager_view_dashboard" in page_perms %}
        <p><a href="{% url 'page_dashboard' page_slug=page.page_slug %}">Dashboard</a></p>
    {% endif %}

    <h3>Page Images</h3>
    <ul>
        {% for image in page.images %}
            <li><img src="{{ image.image.url }}" width="200" />{{ image.caption }}</li>
        {% endfor %}
    </ul>

    <h3>Donations</h3>
    {% if page.donations %}
        <h4>Top Donors</h4>
        <ul>
            {% for a, b in page.top_donors %}
                <li>{{ b.amount|cents_to_dollars }} - {{ b.first_name }} {{ b.last_name }}</li>
            {% endfor %}
        </ul>

        <h4>All Donations</h4>
        <ul>
            {% for d in page.donations %}
                <li>{% if d.anonymous_amount and d.anonymous_donor %}Anonymous donation{% endif %}{% if not d.anonymous_amount %}{{ d.amount|cents_to_dollars }}{% endif %}{% if not d.anonymous_amount and not d.anonymous_donor %} - {% endif %}{% if not d.anonymous_donor %}{% if d.user %}{{ d.user.first_name }} {{ d.user.last_name }}{% else %}{{ d.donor_first_name }} {{ d.donor_last_name }}{% endif %}{% endif %} @ {{ d.date }}{% if d.campaign %} via <a href="{% url 'campaign' page_slug=page.page_slug campaign_pk=d.campaign.pk campaign_slug=d.campaign.campaign_slug %}">{{ d.campaign.name }}</a>{% endif %}
                    {% if d.comment %}
                        <ul>
                            <li>{{ d.comment }}</li>
                        </ul>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No donations!</p>
    {% endif %}

    {% if request.user.is_authenticated %}
        {% include "donation/donate.html" with page=page donate_form=donate_form api_key=api_key%}
    {% else %}
        {% include "donation/donate_unauthenticated.html" with page=page donate_form=donate_form api_key=api_key%}
    {% endif %}

{% endblock %}

