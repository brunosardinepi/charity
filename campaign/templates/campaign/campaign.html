{% extends '_layout.html' %}
{% load static from staticfiles %}
{% load guardian_tags %}
{% load comment_extras %}
{% load donation_extras %}

{% block title %} {{ campaign.name }} | {{ block.super }}{% endblock %}

{% block head_extra %}
    <script src="{% static 'js/comment_csrf.js' %}"></script>
    <script>
        $(document).ready(function() {

            $(".delete-campaign").click(function () {
                return confirm("Are you sure you want to delete this Campaign?");
            });

            $("#delete_image").click(function () {
                return confirm("Are you sure you want to delete this Image? This image will be removed permanently.");
            });

            $("#update_profile").click(function () {
                return confirm("Save this image as the Campaign Profile Image?");
            });

            function comment() {
                $.ajax({
                    url : "{% url 'comments:comment' model='campaign' pk=campaign.pk %}",
                    type : "POST",
                    data : { comment_text : $("#comment-text").val() },
                    success : function(json) {
                        $("#comment-text").val('');
                        if (!$("#comment_list").length) {
                            $("#no-comments").remove();
                            $("#comment").after("<ul id='comment_list'></ul>");
                        }
                        $("#comment_list").prepend("<li id='comment-" + json.id + "' class='comment'>" + json.content + " - " + json.user + " @ " + json.date + " - <a class='show-reply' id='" + json.id + "' href=''>Reply</a> - <a id='delete-comment-" + json.id + "' class='delete-cr' href=''>Delete</a></li>");
                    }
                });
            };

            $("#comment").on('submit', function(event) {
                event.preventDefault();
                comment();
            });

            function show_reply_textarea(event) {
                var url = "{% url 'comments:reply' comment_pk=0 %}".replace(0, event.target.id);
                $(event.target).parent().after("<form id='reply' action=" + url + " method='POST'>{% csrf_token %}<textarea id='reply-text'></textarea><input type='submit' value='Reply' /></form>");
            };

            function reply(id) {
                $.ajax({
                    url : "{% url 'comments:reply' comment_pk=0 %}".replace(0, id),
                    type : "POST",
                    data : { reply_text : $("#reply-text").val() },
                    success : function(json) {
                        $("#reply").remove();
                        if (!$("#comment-" + id + "-replies").length) {
                            if ($("#delete-comment-" + id).length) {
                                $("#delete-comment-" + id).after("<ul id='comment-" + id + "-replies' class='reply-list'></ul>");
                            } else if ("#" + id.length) {
                                $("#" + id).after("<ul id='comment-" + id + "-replies' class='reply-list'></ul>");
                            }
                        }
                        $("#comment-" + id + "-replies").append("<li id='reply-" + json.id + "'>" + json.content + " - " + json.user + " @ " + json.date + " - <a id='delete-reply-" + json.id + "' class='delete-cr' href=''>Delete</a></li>");
                    }
                });
            };

            $(document).on('click', ".show-reply", function(event) {
                event.preventDefault();
                show_reply_textarea(event);
            });

            $(document).on('submit', "#reply", function(event) {
                event.preventDefault();
                var id = $("#reply").prev().find(".show-reply").attr("id");
                reply(id);
            });

            function delete_obj(event) {
                var arr = event.target.id.split('-');
                var url = "{% url 'comments:delete' model=0 pk=1 %}".replace(0, arr[1]).replace(1, arr[2]);
                $.get(url, function () {
                    $("#" + arr[1] + "-" + arr[2]).remove();
                });
            };

            $(document).on('click', ".delete-cr", function(event) {
                event.preventDefault();
                delete_obj(event);
            });

        });
    </script>
{% endblock %}

{% block breadcrumbs %}
    <a href="{% url 'page' page_slug=campaign.page.page_slug %}">{{ campaign.page.name }}</a> / {{ campaign.name }}
{% endblock %}

{% block body_content %}
    <h1>{{ campaign.name }}</h1>
    <img src="{{ campaign.profile_image.image.url }}" width="200" />
    <p>Trending score: {{ campaign.trending_score }}</p>
    <p>Type: {{ campaign.get_type_display }}</p>
    <p>Location: {% if campaign.city %}{{ campaign.city }}{% endif %}{% if campaign.city and campaign.state %}, {% endif %}{% if campaign.state %}{{ campaign.state }}{% endif %}</p>
    <p>Description: {{ campaign.description }}</p>
    <p>Goal: ${{ campaign.goal }}</p>
    <p>${{ campaign.donation_money }} raised by {{ campaign.donation_count }} donors</p>

    <h3>Comments</h3>
    {% if request.user.is_authenticated %}
        <form id="comment" action="{% url 'comments:comment' model='campaign' pk=campaign.pk %}" method="POST">
            {% csrf_token %}
            {{ form.as_p }}
            <input type="submit" value="Comment" />
        </form>
    {% else %}
        <p>You must be logged in to comment!</p>
    {% endif %}
    {% if campaign.comments %}
        <ul id="comment_list">
            {% for c in campaign.comments %}
                <li id="comment-{{ c.pk }}" class="comment">
                    {{ c.content }} - {{ c.user.first_name }} {{ c.user.last_name }} @ {{ c.date|date:"m/d/y g:i A" }} - <a class="show-reply" id="{{ c.pk }}" href="">Reply</a>{% if c.user == request.user %} - <a id="delete-comment-{{ c.pk }}" class="delete-cr" href="">Delete</a>{% endif %}</a>
                    {% comment_replies c.pk as replies %}
                    {% if replies %}
                        <ul id="comment-{{ c.pk }}-replies" class="reply-list">
                            {% for r in replies %}
                                <li id="reply-{{ r.pk }}" class="reply">{{ r.content }} - {{ r.user.first_name }} {{ r.user.last_name }} @ {{ r.date|date:"m/d/y g:i A" }} {% if r.user == request.user %} - <a id="delete-reply-{{ r.pk }}" class="delete-cr" href="">Delete</a>{% endif %}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p id="no-comments">No comments</p>
    {% endif %}

    {% if request.user.userprofile in campaign.campaign_admins.all %}
        <h4>Admin</h4>
        <p><a href="{% url 'campaign_edit' page_slug=campaign.page.page_slug campaign_pk=campaign.pk campaign_slug=campaign.campaign_slug %}">Edit Campaign</a></p>
        <p><a class="delete-campaign" href="{% url 'campaign_delete' page_slug=campaign.page.page_slug campaign_pk=campaign.pk campaign_slug=campaign.campaign_slug %}">Delete Campaign</a></p>
        <p><a href="{% url 'campaign_invite' page_slug=campaign.page.page_slug campaign_pk=campaign.pk campaign_slug=campaign.campaign_slug %}">Invite others to manage Campaign</a></p>
        <p><a href="{% url 'campaign_image_upload' page_slug=campaign.page.page_slug campaign_pk=campaign.pk campaign_slug=campaign.campaign_slug %}">Upload image</a></p>
        {% if campaign.managers_list %}
            <h5>Managers</h5>
            <form method="POST" action"">
                {% csrf_token %}
                <table>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Edit</th>
                        <th>Delete</th>
                        <th>Invite</th>
                        <th>Upload</th>
                        <th></th>
                    </tr>
                {% for manager in campaign.managers_list %}
                    {% get_obj_perms manager.user for campaign as "campaign_perms" %}
                    <tr>
                        <td>{{ manager.first_name }} {{ manager.last_name }}</td>
                        <td>{{ manager.user.email }}</td>
                        <td><input name="permissions[]" type="checkbox" value="{{ manager.pk }}_manager_edit" {% if 'manager_edit' in campaign_perms %}checked{% endif %} /></td>
                        <td><input name="permissions[]" type="checkbox" value="{{ manager.pk }}_manager_delete" {% if 'manager_delete' in campaign_perms %}checked{% endif %} /></td>
                        <td><input name="permissions[]" type="checkbox" value="{{ manager.pk }}_manager_invite" {% if 'manager_invite' in campaign_perms %}checked{% endif %} /></td>
                        <td><input name="permissions[]" type="checkbox" value="{{ manager.pk }}_manager_image_edit" {% if 'manager_image_edit' in campaign_perms %}checked{% endif %} /></td>
                        <td><a href="{% url 'remove_manager' page_slug=campaign.page.page_slug campaign_pk=campaign.pk campaign_slug=campaign.campaign_slug manager_pk=manager.pk %}">Remove<a/></td>
                {% endfor %}
                </table>
                <input type="submit" value="Save" />
            </form>
        {% endif %}
    {% else %}
        <p>you're NOT an admin</p>
    {% endif %}

    {% if request.user.userprofile not in campaign.page.admins.all %}
        {% get_obj_perms request.user for campaign as "campaign_perms" %}
        {% if campaign_perms %}
            <h4>Manager</h4>
        {% endif %}
        {% if "manager_edit" in campaign_perms %}
            <p><a href="{% url 'campaign_edit' page_slug=campaign.page.page_slug campaign_pk=campaign.pk campaign_slug=campaign.campaign_slug %}">Edit Campaign</a></p>
        {% endif %}
        {% if "manager_delete" in campaign_perms %}
            <p><a class="delete-campaign" href="{% url 'campaign_delete' page_slug=campaign.page.page_slug campaign_pk=campaign.pk campaign_slug=campaign.campaign_slug %}">Delete Campaign</a></p>
        {% endif %}
        {% if "manager_invite" in campaign_perms %}
            <p><a href="{% url 'campaign_invite' page_slug=campaign.page.page_slug campaign_pk=campaign.pk campaign_slug=campaign.campaign_slug %}">Invite others to manage Campaign</a></p>
        {% endif %}
        {% if "manager_image_edit" in campaign_perms %}
            <p><a href="{% url 'campaign_image_upload' page_slug=campaign.page.page_slug campaign_pk=campaign.pk campaign_slug=campaign.campaign_slug %}">Upload image</a></p>
        {% endif %}
    {% endif %}

    <h3>Campaign Images</h3>
    <ul>
        {% for image in campaign.images %}
            <li><img src="{{ image.image.url }}" width="200" />{{ image.caption }}<br/>
            {% if "manager_image_edit" in page_perms or request.user.userprofile in campaign.page.admins.all %}    
            <p><a id="delete_image" href="{% url 'campaign_image_delete' page_slug=campaign.page.page_slug campaign_slug=campaign.campaign_slug campaign_pk=campaign.pk image_pk=image.pk %}">Delete Image</a></p>
            <p><a id="update_profile" href="{% url 'campaign_profile_update' page_slug=campaign.page.page_slug campaign_slug=campaign.campaign_slug campaign_pk=campaign.pk image_pk=image.pk %}">Update Profile Image</a></p></li>
            {% endif %}
        {% endfor %}
    </ul>

    <h3>Donations</h3>
    {% if campaign.donations %}

        <h4>Top Donors</h4>
        <ul>
            {% for a, b in campaign.top_donors %}
                <li>{{ b.amount|cents_to_dollars }} - {{ b.first_name }} {{ b.last_name }}</li>
            {% endfor %}
        </ul>

        <h4>All Donations</h4>
        <ul>
            {% for d in campaign.donations %}
                <li>{{ d.amount|cents_to_dollars }} {% if not d.anonymous %}- {{ d.user.first_name }} {{ d.user.last_name }} {% endif %}@ {{ d.date }}
                    {% if d.comment %}
                        <ul>
                            <li>{{ d.comment }}</li>
                        </ul>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No donations!</p>
    {% endif %}

    <h3>Donate</h3>
    <form action="{% url 'campaign_donate' campaign_pk=campaign.pk %}" method="post" id="payment-form">
        {% csrf_token %}
        <div class="form-row">
            {{ donate_form.as_p  }}
            <label for="card-element">Credit or debit card</label>
            <div id="card-element"></div>
            <div id="card-errors" role="alert"></div>
        </div>
        <button>Donate</button>
    </form>

    <script>
        function stripeTokenHandler(token) {
            var form = document.getElementById('payment-form');
            var hiddenInput = document.createElement('input');
            hiddenInput.setAttribute('type', 'hidden');
            hiddenInput.setAttribute('name', 'stripeToken');
            hiddenInput.setAttribute('value', token.id);
            form.appendChild(hiddenInput);

            form.submit();
        }

        var stripe = Stripe('{{ api_pk }}');
        var elements = stripe.elements();

        var style = {
            base: {
                fontSize: '16px',
                lineHeight: '24px'
            }
        };

        var card = elements.create('card', {style: style});
        card.mount('#card-element');

        card.addEventListener('change', function(event) {
            var displayError = document.getElementById('card-errors');
            if (event.error) {
                displayError.textContent = event.error.message;
            } else {
                displayError.textContent = '';
            }
        });

        var form = document.getElementById('payment-form');
        form.addEventListener('submit', function(event) {
            event.preventDefault();

            if (document.getElementById("id_anonymous").checked) {
                var extraDetails = {};
            } else {
                var extraDetails = {
                    name: "{{ request.user.first_name }} {{ request.user.last_name }}",
                };
            };

            stripe.createToken(card, extraDetails).then(function(result) {
                if (result.error) {
                    var errorElement = document.getElementById('card-errors');
                    errorElement.textContent = result.error.message;
                } else {
                    stripeTokenHandler(result.token);
                }
            });
        });
    </script>

{% endblock %}
