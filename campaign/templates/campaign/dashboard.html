{% extends '_layout.html' %}
{% load static from staticfiles %}
{% load guardian_tags %}
{% load donation_extras %}

{% block title %} {{ campaign.name }} | Dashboard | {{ block.super }}{% endblock %}

{% block head_extra %}
    <script src="{% static 'js/comment_csrf.js' %}"></script>
    <script>
        $(document).ready(function() {
            $(".delete-campaign").click(function () {
                return confirm("Are you sure you want to delete this Campaign?");
            });
        });


        function sort(event, column) {
            var parent_th = $(event.target).parent("th");
            if (parent_th.hasClass("desc")) {
                var sort_by = "asc";
            } else {
                var sort_by = "desc";
            };

            var url = "{% url 'campaign_ajax_donations' %}";

            $.ajax({
                url : url,
                type : "POST",
                traditional: true,
                data : {
                    campaign_pk : "{{ campaign.pk }}",
                    sort_by : sort_by,
                    column : column,
                },
                success : function(result) {
                    $("#donation-history-body").empty();
                    parent_th.attr("class", sort_by);
                    for (var key in result) {
                        var date = result[key]["date"];
                        if (result[key]["anonymous_amount"] == true) {
                            var amount = "Anonymous";
                        } else if (result[key]["anonymous_amount"] == false) {
                            var amount = "$" + result[key]['amount'] / 100;
                        };
                        if (result[key]["anonymous_donor"] == true) {
                            var donor = "Anonymous";
                        } else if (result[key]["anonymous_donor"] == false) {
                            var donor = result[key]["user"]["first_name"] + " " + result[key]["user"]["last_name"];
                        };
                        $("#donation-history-body").append("<tr><td>" + date + "</td><td>" + amount + "</td></td><td>" + donor + "</td></tr>");
                    }
                }
            });
        };

        $(document).on("click", ".sort", function(event) {
            event.preventDefault();
            var column = $(event.target).attr("id");
            sort(event, column);
        });
    </script>
{% endblock %}

{% block breadcrumbs %}
    <a href="{% url 'page' page_slug=campaign.page.page_slug %}">{{ campaign.page.name }}</a> / <a href="{% url 'campaign' page_slug=campaign.page.page_slug campaign_pk=campaign.pk campaign_slug=campaign.campaign_slug %}">{{ campaign.name }}</a> / Dashboard
{% endblock %}

{% block body_content %}
    <h1>{{ campaign.name }}</h1>
    {% if request.user.userprofile in campaign.campaign_admins.all %}
        <p><a href="{% url 'campaign_edit' page_slug=campaign.page.page_slug campaign_pk=campaign.pk campaign_slug=campaign.campaign_slug %}">Edit Campaign</a></p>
        <p><a class="delete-campaign" href="{% url 'campaign_delete' page_slug=campaign.page.page_slug campaign_pk=campaign.pk campaign_slug=campaign.campaign_slug %}">Delete Campaign</a></p>
        <p><a href="{% url 'campaign_invite' page_slug=campaign.page.page_slug campaign_pk=campaign.pk campaign_slug=campaign.campaign_slug %}">Invite others to manage Campaign</a></p>
        <p><a href="{% url 'campaign_image_upload' page_slug=campaign.page.page_slug campaign_pk=campaign.pk campaign_slug=campaign.campaign_slug %}">Upload and Edit images</a></p>
        <p><a href="{% url 'campaign_edit_vote' page_slug=campaign.page.page_slug campaign_pk=campaign.pk campaign_slug=campaign.campaign_slug %}">Edit vote participants</a></p>
        {% if campaign.managers_list %}
            <h5>Managers</h5>
            <form method="POST" action"">
                {% csrf_token %}
                <table>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Edit</th>
                        <th>Delete</th>
                        <th>Invite</th>
                        <th>Upload</th>
                        <th>View Dashboard</th>
                        <th></th>
                    </tr>
                {% for manager in campaign.managers_list %}
                    {% get_obj_perms manager.user for campaign as "campaign_perms" %}
                    <tr>
                        <td>{{ manager.first_name }} {{ manager.last_name }}</td>
                        <td>{{ manager.user.email }}</td>
                        <td><input name="permissions[]" type="checkbox" value="{{ manager.pk }}_manager_edit" {% if 'manager_edit' in campaign_perms %}checked{% endif %} /></td>
                        <td><input name="permissions[]" type="checkbox" value="{{ manager.pk }}_manager_delete" {% if 'manager_delete' in campaign_perms %}checked{% endif %} /></td>
                        <td><input name="permissions[]" type="checkbox" value="{{ manager.pk }}_manager_invite" {% if 'manager_invite' in campaign_perms %}checked{% endif %} /></td>
                        <td><input name="permissions[]" type="checkbox" value="{{ manager.pk }}_manager_image_edit" {% if 'manager_image_edit' in campaign_perms %}checked{% endif %} /></td>
                        <td><input name="permissions[]" type="checkbox" value="{{ manager.pk }}_manager_view_dashboard" {% if 'manager_view_dashboard' in campaign_perms %}checked{% endif %} /></td>
                        <td><a href="{% url 'remove_manager' page_slug=campaign.page.page_slug campaign_pk=campaign.pk campaign_slug=campaign.campaign_slug manager_pk=manager.pk %}">Remove<a/></td>
                {% endfor %}
                </table>
                <input type="submit" value="Save" />
            </form>
        {% endif %}
    {% else %}
        {% get_obj_perms request.user for campaign as "campaign_perms" %}
        {% if campaign_perms %}
            <h4>Manager</h4>
        {% endif %}
        {% if "manager_edit" in campaign_perms %}
            <p><a href="{% url 'campaign_edit' page_slug=campaign.page.page_slug campaign_pk=campaign.pk campaign_slug=campaign.campaign_slug %}">Edit Campaign</a></p>
        {% endif %}
        {% if "manager_delete" in campaign_perms %}
            <p><a class="delete-campaign" href="{% url 'campaign_delete' page_slug=campaign.page.page_slug campaign_pk=campaign.pk campaign_slug=campaign.campaign_slug %}">Delete Campaign</a></p>
        {% endif %}
        {% if "manager_invite" in campaign_perms %}
            <p><a href="{% url 'campaign_invite' page_slug=campaign.page.page_slug campaign_pk=campaign.pk campaign_slug=campaign.campaign_slug %}">Invite others to manage Campaign</a></p>
        {% endif %}
        {% if "manager_image_edit" in campaign_perms %}
            <p><a href="{% url 'campaign_image_upload' page_slug=campaign.page.page_slug campaign_pk=campaign.pk campaign_slug=campaign.campaign_slug %}">Upload and Edit images</a></p>
        {% endif %}
    {% endif %}

    {% if request.user.userprofile in campaign.campaign_admins.all or "manager_view_dashboard" in campaign_perms %}
        <p>Total donated: {{ donations.total_donations|cents_to_dollars }} (Avg: {{ donations.total_donations_avg|cents_to_dollars }})</p>
        <h2>Donation Graph</h2>
        <ul>
            {% for k,v in graph.items %}
                <li>Date: {{ k }}, Donations: {{ v|cents_to_dollars }}</li>
            {% endfor %}
        </ul>
        <h2>Donation History</h2>
        <table>
            <thead>
                <tr>
                    <th class="desc"><a class="sort" id="sort-date" href="">Date</a></th>
                    <th><a class="sort" id="sort-amount" href="">Amount</a></th>
                    <th><a class="sort" id="sort-donor_first_name" href="">Donor</a></th>
                </tr>
            </thead>
            <tbody id="donation-history-body">
                {% for d in campaign.donations %}
                    <tr>
                        <td>{{ d.date|date:'N j, Y, g:i A' }}</td>
                        <td>{% if d.anonymous_amount %}Anonymous{% else %}{{ d.amount|cents_to_dollars }}{% endif %}</td>
                        <td>{% if d.anonymous_donor == True %}Anonymous{% else %}{% if d.user %}{{ d.user.first_name }} {{ d.user.last_name }}{% else %}{{ d.donor_first_name }} {{ d.donor_last_name }}{% endif %}{% endif %}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <h2>Top Donors</h2>
        <ul>
            {% for a, b in campaign.top_donors %}
                <li>{{ b.amount|cents_to_dollars }} - {{ b.first_name }} {{ b.last_name }}</li>
            {% endfor %}
        </ul>
        <h2>Trending Scores</h2>
        <p>Campaign score: {{ campaign.trending_score }}</p>
    {% endif %}
{% endblock %}
