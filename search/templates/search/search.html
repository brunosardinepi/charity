{% extends '_layout.html' %}
{% load static from staticfiles %}

{% block title %} Search | {{ block.super }}{% endblock %}

{% block head_extra %}

<script src="{% static 'js/comment_csrf.js' %}"></script>
<script>
{% if query_from_search %}
    var sq = "{{ query_from_search }}";
    $( document ).ready(function() {
        $("#q").val(sq).trigger("keyup"); ;
    });
{% endif %}

function search(a) {
    var checked = document.getElementsByName('filters[]');
    var filters = [];
    for (c = 0; c < checked.length; c++) {
        if (checked[c].checked) {
            filters.push(checked[c].value);
        }
    }
    var q = $('#q').val();
    q = q.split(/[ ]+/).join(',');

    var s = $('#s').find(":selected").val();

    var url = "{% url 'search:results' %}";
    filters = JSON.stringify(filters);

    $.ajax({
        url : url,
        type : "POST",
        traditional: true,
        data : {
            q : q,
            f : filters,
            s : s,
            a : a
        },
        success : function(json) {
            $("#sponsored-list").empty();
            $("#results-list").empty();
            console.log(json);
            for (var key in json) {
                $("#results-list").append(json[key]);
            }
        }
    });
};

$(document).on('keyup', '#q', function() {
    search("false");
});

$(document).on('change', '#s', function() {
    search("false");
});

$(document).on('keypress', '#q', function(event) {
    if (event.keyCode == 13) {
        event.preventDefault();
        return false;
    }
});

$(document).ready(function() {
    $(":checkbox").change(function() {
        search("false");
    });
});

$(document).ready(function() {
    $("#checkall").click(function(event) {
        event.preventDefault();
        var checkboxes = $(document.getElementsByName('filters[]'));
        checkboxes.prop('checked', !checkboxes.prop('checked')).change();
    });

    $("#allPages").click(function(event) {
        event.preventDefault();
        search("pages");
    });

    $("#allCampaigns").click(function(event) {
        event.preventDefault();
        search("campaigns");
    });
});
</script>
{% endblock %}

{% block body_content %}

    <div class="row mb-4">
        <div class="col-md-auto vote-participant-picture-container">
            <img class="search-result-picture" src="{% static 'img/user_default.svg' %}" />
        </div>

        <div class="col-md-10 mb-4">
            <div class="row justify-content-between">
                <div class="col-md-auto">
                    <h3><a class="teal" href="">Page Name Goes Here</a></h3>
                </div>
                <div class="col d-flex align-items-center h100">
                    City, ST
                </div>
                <div class="col-md-3 vote-amount">
                    <span class="teal font-weight-bold font-size-175">$125</span>
                </div>
            </div>
            <span class="comment-content"><p>Donec et lacinia est. Vestibulum et justo dui. Aliquam sodales rhoncus tellus, ut molestie neque vulputate sit amet. Curabitur quis convallis massa. Fusce a nulla metus. Proin laoreet iaculis lorem ac consequat. Sed eget tempus libero. Interdum et malesuada fames ac ante ipsum primis in faucibus.</p></span>
        </div>
    </div>









    <form>
        <div class="row mt-4 mb-3">
            <div class="col-12 text-center">
                <h1 style="font-weight:normal;">Search for Pages and Campaigns</h1>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-8 offset-2">
                {% csrf_token %}
                <div class="form-group">
                    <input id="q" type="text" class="form-control form-control-lg" placeholder="Search by name or keyword" />
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-2">
                <div class="row">
                    <div class="col-12">
                        <a href="" id="checkall">Select all</a>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <a href="" id="allPages">List all Pages</a>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <a href="" id="allCampaigns">List all Campaigns</a>
                    </div>
                </div>

                {% for k, v in categories.items %}
                    <div class="form-check">
                        <input class="form-check-input" name="filters[]" type="checkbox" value="{{ k }}">{{ v }}</input>
                    </div>
                {% endfor %}

                <div class="form-group mt-5">
                    <label for="s">Filter by location</label>
                    <select id="s" class="form-control">
                        <option value=''>Select...</option>
                        {% for k, v in states.items %}
                            <option value={{ k }}>{{ v }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="col">

                {% if sponsored %}
                    <h3>Sponsored Pages</h3>
                    <ul>
                        {% for page in sponsored %}
                            <li><a href="{% url 'page' page_slug=page.page_slug %}">{{ page.name }}</a></li>
                        {% endfor %}
                    </ul>
                {% endif %}

                {% if trending_pages %}
                    <h3>Trending Pages</h3>
                    <ul>
                        {% for page in trending_pages %}
                            <li><a href="{% url 'page' page_slug=page.page_slug %}">{{ page.name }}</a></li>
                        {% endfor %}
                    </ul>
                {% endif %}

                {% if trending_campaigns %}
                    <h3>Trending Campaigns</h3>
                    <ul>
                        {% for campaign in trending_campaigns %}
                            <li><a href="{% url 'campaign' page_slug=campaign.page.page_slug campaign_pk=campaign.pk campaign_slug=campaign.campaign_slug %}">{{ campaign.name }}</a></li>
                        {% endfor %}
                    </ul>
                {% endif %}

                <div id="sponsored">
                    <h3>Sponsored Results:</h3>
                    <div id="sponsored-list"></div>
                </div>

                <div id="results">
                    <h3>Search Results:</h3>
                    <div id="results-list"></div>
                </div>

            </div>
        </div>
    </form>
{% endblock %}
