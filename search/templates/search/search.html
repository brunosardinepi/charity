{% extends '_layout.html' %}
{% load static from staticfiles %}

{% block title %} Search | {{ block.super }}{% endblock %}

{% block head_extra %}

<script src="{% static 'js/comment_csrf.js' %}"></script>
<script>
function search(a) {
    var checked = document.getElementsByName('filters[]');
    var filters = [];
    for (c = 0; c < checked.length; c++) {
        if (checked[c].checked) {
            filters.push(checked[c].value);
        }
    }
    var q = $('#q').val();
    q = q.split(/[ ]+/).join(',');

    var s = $('#s').find(":selected").val();

    var url = "{% url 'search:results' %}";
    filters = JSON.stringify(filters);

    $.ajax({
        url : url,
        type : "POST",
        traditional: true,
        data : {
            q : q,
            f : filters,
            s : s,
            a : a
        },
        success : function(json) {
            $("#sponsored-list").empty();
            $("#results-list").empty();
            for (var key in json) {
                if (json[key]["city"]) {
                    var location = json[key]["city"] + ", " + json[key]["state"];
                } else if (json[key]["state"]) {
                    var location = json[key]["state"];
                } else {
                    var location = "";
                }
                if (json[key]["sponsored"] == "t") {
                    if (json[key]["model"] == "page") {
                        $("#sponsored-list").append("<li><a href='/" + key +  "/'>" + json[key]['name'] + "</a> " + location + "</li>");
                    } else if (json[key]["model"] == "campaign") {
                        $("#sponsored-list").append("<li><a href='/" + json[key]['page_slug'] + "/" + json[key]['pk'] + "/" + key +  "/'>" + json[key]['name'] + "</a> " + location + "</li>");
                    }
                } else {
                    if (json[key]["model"] == "page") {
                        $("#results-list").append("<li><a href='/" + key +  "/'>" + json[key]['name'] + "</a> " + location + "</li>");
                    } else if (json[key]["model"] == "campaign") {
                        $("#results-list").append("<li><a href='/" + json[key]['page_slug'] + "/" + json[key]['pk'] + "/" + key +  "/'>" + json[key]['name'] + "</a> " + location + "</li>");
                    }
                }
            }
        }
    });
};

$(document).on('keyup', '#q', function() {
    search("false");
});

$(document).on('change', '#s', function() {
    search("false");
});

$(document).on('keypress', '#q', function(event) {
    if (event.keyCode == 13) {
        event.preventDefault();
        return false;
    }
});

$(document).ready(function() {
    $(":checkbox").change(function() {
        search("false");
    });
});

$(document).ready(function() {
    $("#checkall").click(function(event) {
        event.preventDefault();
        var checkboxes = $(document.getElementsByName('filters[]'));
        checkboxes.prop('checked', !checkboxes.prop('checked')).change();
    });

    $("#allPages").click(function(event) {
        event.preventDefault();
        search("pages");
    });

    $("#allCampaigns").click(function(event) {
        event.preventDefault();
        search("campaigns");
    });
});
</script>
{% endblock %}

{% block body_content %}
    <form>
    {% csrf_token %}
    <input id="q" type="text" placeholder="Search" />

    <a href="" id="checkall">Select all</a>

    {% for k, v in categories.items %}
        <input name="filters[]" type="checkbox" value="{{ k }}">{{ v }}</input>
    {% endfor %}

    <select id="s">
        <option value=''>Select...</option>
        {% for k, v in states.items %}
            <option value={{ k }}>{{ v }}</option>
        {% endfor %}
    </select>
    </form>

    <p><a href="" id="allPages">List all Pages</a> <a href="" id="allCampaigns">List all Campaigns</a></p>

    <div id="sponsored">
        <p>Sponsored Results:</p>
        <ul id="sponsored-list"></ul>
    </div>

    <div id="results">
        <p>Search Results:</p>
        <ul id="results-list"></ul>
    </div>
{% endblock %}
